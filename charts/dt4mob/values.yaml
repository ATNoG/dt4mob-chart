imagePullSecrets: []

nameOverride: ""
fullnameOverride: ""

tenant: "test-tenant"

hono:
  messagingNetworkTypes:
    - kafka

  kafkaMessagingClusterExample:
    enabled: false

  livenessProbeInitialDelaySeconds: 900
  readinessProbeInitialDelaySeconds: 45

  useDynamicNodePorts: true
  useLoadBalancer: false
  externalAccess:
    enabled: false

  deviceRegistryExample:
    type: mongodb
    addExampleData: false
    mongoDBBasedDeviceRegistry:
      containerRegistry: "atnog-harbor.av.it.pt"
      imageName: "capucho/hono-service-device-registry-mongodb"
      imageTag: "2.7.0-SNAPSHOT"

      deployment:
        annotations:
          reloader.stakater.com/auto: "true"

      extraEnv:
      - name: KEY_STORE_PASSWORD
        valueFrom:
          secretKeyRef:
            name: "dt4mob-device-registry-kafka-user"
            key: "user.password"

      resources:
        requests:
          cpu: 200m
      mongodb:
        host: '{{ .Release.Name }}-mongodb'
        port: 27017
        dbName: hono

    tlsKeysSecret: "dt4mob-device-registry-cert"
    tlsTrustStoreConfigMap: "none"
    tlsTrustStoreSecret:
      secretName: "dt4mob-device-registry-cert"

    extraVolumes:
    - name: kafka-certs
      secret:
        secretName: "dt4mob-device-registry-kafka-user"
    - name: kafka-trust
      secret:
        secretName: "dt4mob-kafka-cluster-cluster-ca-cert"
    extraVolumeMounts:
    - name: kafka-certs
      mountPath: "/opt/hono/tls/kafka-certs"
      readOnly: true
    - name: kafka-trust
      mountPath: "/opt/hono/tls/kafka-trust"
      readOnly: true

  adapters:
    useExternalAuth: true

    # Despite being in the adapters section, it's shared by all services
    kafkaMessagingSpec:
      commonClientConfig:
        bootstrap.servers: "dt4mob-kafka-cluster-kafka-bootstrap:9092"
        security.protocol: "SSL"
        ssl.truststore.type: "PEM"
        ssl.truststore.location: "/opt/hono/tls/kafka-trust/ca.crt"
        ssl.keystore.type: "PKCS12"
        ssl.keystore.password: ${KEY_STORE_PASSWORD}
        ssl.keystore.location: "/opt/hono/tls/kafka-certs/user.p12"

    mqtt:
      resources:
        requests:
          cpu: 200m

      deployment:
        annotations:
          reloader.stakater.com/auto: "true"

      tlsKeysSecret: "dt4mob-mqtt-adapter-cert"
      tlsTrustStoreConfigMap: "none"
      tlsTrustStoreSecret:
        secretName: "dt4mob-mqtt-adapter-cert"

      extraEnv:
      - name: KEY_STORE_PASSWORD
        valueFrom:
          secretKeyRef:
            name: "dt4mob-mqtt-adapter-kafka-user"
            key: "user.password"

      extraVolumes:
      - name: kafka-certs
        secret:
          secretName: "dt4mob-mqtt-adapter-kafka-user"
      - name: kafka-trust
        secret:
          secretName: "dt4mob-kafka-cluster-cluster-ca-cert"
      extraVolumeMounts:
      - name: kafka-certs
        mountPath: "/opt/hono/tls/kafka-certs"
        readOnly: true
      - name: kafka-trust
        mountPath: "/opt/hono/tls/kafka-trust"
        readOnly: true
    http:
      resources:
        requests:
          cpu: 200m

      deployment:
        annotations:
          reloader.stakater.com/auto: "true"

      tlsKeysSecret: "dt4mob-http-adapter-cert"
      tlsTrustStoreConfigMap: "none"
      tlsTrustStoreSecret:
        secretName: "dt4mob-http-adapter-cert"

      extraEnv:
      - name: KEY_STORE_PASSWORD
        valueFrom:
          secretKeyRef:
            name: "dt4mob-http-adapter-kafka-user"
            key: "user.password"

      extraVolumes:
      - name: kafka-certs
        secret:
          secretName: "dt4mob-http-adapter-kafka-user"
      - name: kafka-trust
        secret:
          secretName: "dt4mob-kafka-cluster-cluster-ca-cert"
      extraVolumeMounts:
      - name: kafka-certs
        mountPath: "/opt/hono/tls/kafka-certs"
        readOnly: true
      - name: kafka-trust
        mountPath: "/opt/hono/tls/kafka-trust"
        readOnly: true
    amqp:
      resources:
        requests:
          cpu: 200m

      deployment:
        annotations:
          reloader.stakater.com/auto: "true"

      tlsKeysSecret: "dt4mob-amqp-adapter-cert"
      tlsTrustStoreConfigMap: "none"
      tlsTrustStoreSecret:
        secretName: "dt4mob-amqp-adapter-cert"

      extraEnv:
      - name: KEY_STORE_PASSWORD
        valueFrom:
          secretKeyRef:
            name: "dt4mob-amqp-adapter-kafka-user"
            key: "user.password"

      extraVolumes:
      - name: kafka-certs
        secret:
          secretName: "dt4mob-amqp-adapter-kafka-user"
      - name: kafka-trust
        secret:
          secretName: "dt4mob-kafka-cluster-cluster-ca-cert"
      extraVolumeMounts:
      - name: kafka-certs
        mountPath: "/opt/hono/tls/kafka-certs"
        readOnly: true
      - name: kafka-trust
        mountPath: "/opt/hono/tls/kafka-trust"
        readOnly: true

  authServer:
    containerRegistry: "atnog-harbor.av.it.pt"
    imageName: "capucho/hono-service-auth"
    imageTag: "2.7.0-SNAPSHOT"

    deployment:
      annotations:
        reloader.stakater.com/auto: "true"

    tlsKeysSecret: "dt4mob-auth-server-cert"
    tlsTrustStoreSecret:
      secretName: "dt4mob-auth-server-cert"

    resources:
      requests:
        cpu: "200m"
        memory: "196Mi"
      limits:
        cpu: "1"
        memory: "256Mi"

    extraVolumes:
      - name: "permissions"
        secret:
          secretName: "dt4mob-permissions"
    extraVolumeMounts:
      - name: "permissions"
        mountPath: "/var/run/hono/auth"
    hono:
      auth:
        svc:
          permissionsPath: "/var/run/hono/auth/permissions.json"
          supportedSaslMechanisms: "EXTERNAL"
          signing:
            # tokenExpiration contains the number of seconds after which tokens issued
            # by the Auth server will expire.
            tokenExpiration: 3600


  commandRouterService:
    containerRegistry: "atnog-harbor.av.it.pt"
    imageName: "capucho/hono-service-command-router-infinispan"
    imageTag: "2.7.0-SNAPSHOT"

    deployment:
      annotations:
        reloader.stakater.com/auto: "true"

    tlsKeysSecret: "dt4mob-command-router-cert"
    tlsTrustStoreConfigMap: "none"
    tlsTrustStoreSecret:
      secretName: "dt4mob-command-router-cert"

    resources:
      limits:
        cpu: "1"
        memory: "800Mi"

    extraEnv:
    - name: KEY_STORE_PASSWORD
      valueFrom:
        secretKeyRef:
          name: "dt4mob-command-router-kafka-user"
          key: "user.password"

    extraVolumes:
    - name: kafka-certs
      secret:
        secretName: "dt4mob-command-router-kafka-user"
    - name: kafka-trust
      secret:
        secretName: "dt4mob-kafka-cluster-cluster-ca-cert"
    extraVolumeMounts:
    - name: kafka-certs
      mountPath: "/opt/hono/tls/kafka-certs"
      readOnly: true
    - name: kafka-trust
      mountPath: "/opt/hono/tls/kafka-trust"
      readOnly: true

ditto:
  # TODO
  global:
    basicAuthUsers:
    - user: ditto
      password: ditto

  connectivity:
    resources:
      cpu: 0.2
      memoryMi: 1024
    image:
      repository: atnog-harbor.av.it.pt/capucho/ditto-connectivity
      tag: 0-SNAPSHOT
      pullPolicy: Always

  gateway:
    resources:
      cpu: 0.2
      memoryMi: 768
    config:
      authentication:
        devops:
          existingSecret: "dt4mob-ditto-gateway-secret"

  policies:
    resources:
      cpu: 0.2
      memoryMi: 768

  things:
    resources:
      cpu: 0.2
      memoryMi: 768

  thingsSearch:
    resources:
      cpu: 0.2
      memoryMi: 768

  dittoui:
    resources:
      cpu: 0.05
      memoryMi: 32

  ingress:
    enabled: true
    className: nginx
    # Use this instead of setting existingSecret because otherwise the secret
    # needs to exist before the chart is rendered.
    api:
      kubernetesAuthAnnotations: |
        nginx.ingress.kubernetes.io/auth-type: basic
        nginx.ingress.kubernetes.io/auth-secret: {{ .Release.Name }}-auth-secret
        nginx.ingress.kubernetes.io/auth-realm: 'Authentication required to use HTTP API!'

  swaggerui:
    resources:
      memoryMi: 64

  nginx:
    service:
      type: ClusterIP
    resources:
      cpu: 0.05
      memoryMi: 32

  # TODO: Use replicated mongo
  mongodb:
    enabled: true
    resources:
      requests:
        cpu: 150m
        memory: "256Mi"
      limits:
        cpu: 1.0
        memory: "512Mi"
    livenessProbe:
      initialDelaySeconds: 40
      periodSeconds: 30
      timeoutSeconds: 15
    readinessProbe:
      initialDelaySeconds: 30
      periodSeconds: 15
      timeoutSeconds: 13

controller:
  image:
    repository: atnog-harbor.av.it.pt/capucho/dt4mob-controller
    pullPolicy: Always # IfNotPresent
    tag: "latest"

  serviceAccount:
    create: true
    automount: true
    annotations: {}
    name: ""

  extraVolumes: []
  extraVolumeMounts: []

  podAnnotations: {}
  podLabels: {}
  podSecurityContext: {}
  securityContext: {}
  resources: {}
  nodeSelector: {}
  tolerations: []
  affinity: {}

kafka:
  controller:
    replicas: 1
  broker:
    replicas: 1
  config:
    # offsets.topic.replication.factor: 3
    # transaction.state.log.replication.factor: 3
    # transaction.state.log.min.isr: 2
    # default.replication.factor: 3
    # min.insync.replicas: 2
    offsets.topic.replication.factor: 1
    transaction.state.log.replication.factor: 1
    transaction.state.log.min.isr: 1
    default.replication.factor: 1
    min.insync.replicas: 1

reloader:
  watchGlobally: false
